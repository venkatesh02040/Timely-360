<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIMELY 360 - Login</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="istyles.css">
</head>

<body>
    <div class="container-fluid w-100">
        <header class="py-3 text-white text-center">
            <img src="vyl.jpeg" alt="Company Logo">
            <h1>TIMELY 360</h1>
        </header>
        <div class="row mt-4">
            <!-- Calendar Section -->
            <div class="col-md-8">
                <div id="calendar" class="p-3 bg-light rounded">
                    <h2 class="text-center">Calendar</h2>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <button class="btn btn-secondary btn-sm" id="prevMonth">Previous</button>
                        <h4 id="currentMonthYear" class="mb-0"></h4>
                        <button class="btn btn-secondary btn-sm" id="nextMonth">Next</button>
                    </div>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Sun</th>
                                <th>Mon</th>
                                <th>Tue</th>
                                <th>Wed</th>
                                <th>Thu</th>
                                <th>Fri</th>
                                <th>Sat</th>
                            </tr>
                        </thead>
                        <tbody id="calendarDays">
                            <!-- Days will be dynamically populated here -->
                        </tbody>
                    </table>
                </div>
                <!-- Legend -->
                <div class="mt-3">
                    <p>
                        <span class="badge bg-success">Public Holiday</span>
                        <span class="badge bg-info">Festival</span>
                    </p>
                </div>
            </div>

            <!-- Authentication Section -->
            <div class="col-md-4">
                <div class="p-4 bg-light rounded" id="userportal">
                    <h2 class="text-center">User Portal</h2>
                    <ul class="nav nav-tabs justify-content-center mb-4" id="authTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login"
                                type="button" role="tab">Login</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register"
                                type="button" role="tab">Register</button>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <!-- Login Form -->
                        <div class="tab-pane fade show active" id="login" role="tabpanel">
                            <form id="loginForm">
                                <div class="mb-3">
                                    <label for="loginEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="loginEmail"
                                        placeholder="Enter your email" required>
                                </div>
                                <div class="mb-3">
                                    <label for="loginPassword" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="loginPassword"
                                        placeholder="Enter your password" required>
                                </div>
                                <div class="mb-3">
                                    <label for="role" class="form-label">Role</label>
                                    <select class="form-select" id="role" required>
                                        <option value="">Select Role</option>
                                        <option value="admin">Admin</option>
                                        <option value="employee">Employee</option>
                                    </select>
                                </div>
                                <button type="submit" class=" w-100" id="login-btn">Login</button>
                                <div class="text-end mb-3">
                                    <a href="#" id="forgotPassword" class="text-primary">Forgot Password?</a>
                                </div>
                            </form>
                        </div>
                        <!-- Register Form -->
                        <div class="tab-pane fade" id="register" role="tabpanel">
                            <form id="registerForm">
                                <div class="mb-3">
                                    <label for="registerName" class="form-label">Name</label>
                                    <input type="text" class="form-control" id="registerName"
                                        placeholder="Enter your name" required>
                                </div>
                                <div class="mb-3">
                                    <label for="registerEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="registerEmail"
                                        placeholder="Enter your email" required>
                                </div>
                                <div class="mb-3">
                                    <label for="registerPassword" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="registerPassword"
                                        placeholder="Enter your password" required>
                                </div>
                                <div class="mb-3">
                                    <label for="registerRole" class="form-label">Role</label>
                                    <select class="form-select" id="registerRole" required>
                                        <option value="">Select Role</option>
                                        <option value="admin">Admin</option>
                                        <option value="employee">Employee</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="registerMobile" class="form-label">Mobile Number</label>
                                    <input type="text" class="form-control" id="registerMobile"
                                        placeholder="Enter your mobile number" required>
                                </div>
                                <div class="mb-3">
                                    <label for="registerDob" class="form-label">Date of Birth</label>
                                    <input type="date" class="form-control" id="registerDob" required>
                                </div>
                                <div class="mb-3">
                                    <label for="registerPhoto" class="form-label">Upload Photo</label>
                                    <input type="file" class="form-control" id="registerPhoto" accept="image/*"
                                        required>
                                </div>
                                <button type="submit" class=" w-100" id="register-btn">Register</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Holiday Details -->
    <div class="modal fade" id="holidayModal" tabindex="-1" aria-labelledby="holidayModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="holidayModalLabel">Holiday Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="holidayDetails">
                    <!-- Holiday details will be dynamically populated here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Registration Success -->
    <div class="modal fade" id="registrationModal" tabindex="-1" aria-labelledby="registrationModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registrationModalLabel">Registration Successful</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    You have successfully registered. Please login with your credentials.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" data-bs-toggle="tab"
                        data-bs-target="#login">Go to Login</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs/dayjs.min.js"></script>
    <!-- <script src="index.js"></script> -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const currentDate = dayjs();
            let selectedDate = currentDate;

            const monthYearLabel = document.getElementById("currentMonthYear");
            const prevButton = document.getElementById("prevMonth");
            const nextButton = document.getElementById("nextMonth");
            const calendarDays = document.getElementById("calendarDays");

            // Mock Data: Holidays
            const holidays = [
                { date: "2024-01-01", type: "public", name: "New Year's Day", description: "Celebration of the New Year." },
                { date: "2024-01-26", type: "public", name: "Republic Day", description: "Commemoration of the Indian Republic." },
                { date: "2024-10-31", type: "festival", name: "Diwali", description: "Festival of Lights celebrated across India." },
                { date: "2025-01-01", type: "public", name: "New Year's Day", description: "Celebration of the New Year." }
            ];

            // Update Calendar
            function updateCalendar(date) {
                monthYearLabel.textContent = date.format("MMMM YYYY");
                calendarDays.innerHTML = "";

                const startOfMonth = date.startOf("month");
                const endOfMonth = date.endOf("month");
                const startDay = startOfMonth.day();
                const totalDays = endOfMonth.date();

                let row = document.createElement("tr");

                for (let i = 0; i < startDay; i++) {
                    const blankCell = document.createElement("td");
                    row.appendChild(blankCell);
                }

                for (let day = 1; day <= totalDays; day++) {
                    const dayCell = document.createElement("td");
                    const fullDate = date.date(day).format("YYYY-MM-DD");

                    const dayOfWeek = date.date(day).day();
                    if (dayOfWeek === 0) dayCell.classList.add("sunday");
                    if (dayOfWeek === 6 && day >= 8 && day <= 14) dayCell.classList.add("second-saturday");
                    if (dayOfWeek === 6 && day >= 22 && day <= 28) dayCell.classList.add("fourth-saturday");

                    const holiday = holidays.find(h => h.date === fullDate);
                    if (holiday) {
                        dayCell.classList.add(holiday.type === "public" ? "bg-success" : "bg-info");
                        dayCell.setAttribute("title", `${holiday.name}: ${holiday.description}`);
                        dayCell.addEventListener("click", () => {
                            const holidayDetails = document.getElementById("holidayDetails");
                            holidayDetails.textContent = `${holiday.name}: ${holiday.description}`;
                            const myModal = new bootstrap.Modal(document.getElementById('holidayModal'));
                            myModal.show();
                        });
                    }

                    if (date.date(day).isSame(currentDate, 'day')) {
                        dayCell.classList.add("current-day");
                    }

                    dayCell.textContent = day;
                    row.appendChild(dayCell);

                    if ((startDay + day) % 7 === 0) {
                        calendarDays.appendChild(row);
                        row = document.createElement("tr");
                    }
                }

                if (row.children.length > 0) {
                    calendarDays.appendChild(row);
                }
            }

            prevButton.addEventListener("click", () => {
                selectedDate = selectedDate.subtract(1, "month");
                updateCalendar(selectedDate);
            });

            nextButton.addEventListener("click", () => {
                selectedDate = selectedDate.add(1, "month");
                updateCalendar(selectedDate);
            });

            updateCalendar(currentDate);

            registerForm.addEventListener("submit", (e) => {
                e.preventDefault();

                const name = document.getElementById("registerName").value;
                const email = document.getElementById("registerEmail").value;
                const mobile = document.getElementById("registerMobile").value;
                const password = document.getElementById("registerPassword").value;
                const role = document.getElementById("registerRole").value;
                const dob = document.getElementById("registerDob").value;
                const photoInput = document.getElementById("registerPhoto");

                if (!name || !email || !password || !role || !dob || !photoInput.files.length) {
                    alert("Please fill out all fields.");
                    return;
                }

                const photoFile = photoInput.files[0];
                const reader = new FileReader();

                // Handle the photo file after it's read
                reader.onload = function (event) {
                    const photoBase64 = event.target.result;

                    // User data object
                    const userData = { name, email, mobile, password, role, dob, photo: photoBase64 };

                    // Post user data to db.json
                    fetch("http://localhost:3000/users", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify(userData)
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error("Failed to register user.");
                            }
                            return response.json();
                        })
                        .then(() => {
                            alert("Registration successful!");
                            registerForm.reset();
                        })
                        .catch(error => {
                            alert("Error registering user. Please try again.");
                            console.error(error);
                        });
                };

                // Read the uploaded photo as Base64
                reader.readAsDataURL(photoFile);
            });


            loginForm.addEventListener("submit", (e) => {
                e.preventDefault();

                const email = document.getElementById("loginEmail").value;
                const password = document.getElementById("loginPassword").value;
                const role = document.getElementById("role").value;

                if (!email || !password || !role) {
                    alert("Please fill out all fields.");
                    return;
                }

                // Check if user exists in db.json
                fetch("http://localhost:3000/users")
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Failed to fetch users.");
                        }
                        return response.json();
                    })
                    .then(users => {
                        console.log(users);

                        // Log the users to check the data
                        const user = users.find(u => u.email === email && u.role === role);

                        // let fd = users.filter(i => { return i.email == email })
                        // let user = fd[0]


                        if (!user) {
                            console.log("No user found with the given email and role");
                            alert("Invalid credentials. Please try again.");
                            return;
                        }

                        if (user.password != password) {
                            console.log("Password doesn't match");
                            alert("Invalid credentials. Please try again.");
                            return;
                        }

                        alert("login success")


                        delete user.password
                        // // Store user details in localStorage (excluding password)
                        localStorage.setItem("loggedInUser", JSON.stringify(user));

                        // Welcome message
                        alert(`Welcome, ${user.name}!`);

                        // Redirect based on role
                        if (role === "employee") {
                            window.location.href = "employee.html";
                        } else if (role === "admin") {
                            window.location.href = "admin.html";
                        }
                    })
                    .catch(error => {
                        alert("Error logging in. Please try again.");
                        console.error(error);
                    });
            });



        });

    </script>

</body>

</html>